# Arelのモンキーパッチ対応

@tkoyama1988

---

## アジェンダ

- 誰？
- 普段何してるの？
- モンキーパッチを当てる経緯
-

---

## 誰?（Who are you?）

- @tkoyama1988 小山貴之
- 株式会社SUPER STUDIO バックエンドエンジニア
- 経歴
  - バイト/正社員 3年：主にAndroid
  - 個人事業主 2.5年：Android, Unity, Back, Front
  - 法人化 1.5年：スマホ全般, AWS, Back, Front
  - SUPERSTUDIO 10月入社：主にRails

--

- 資格
  - 基本/応用情報技術者
  - LPIC1/2
  - CCNA
  - Androidベーシック
  - JavaSE8/Ruby2.1 Silver/Gold

---

## SUPER STUDIOで普段何してるの？
- EC-Force開発, 技術全般サポート

![image](img/product.png)

---

## LTネタ
- Railsドキュメントに貢献する
- Arelのモンキーパッチ対応

---

## Railsドキュメントに貢献する
- 大したことしてない😅
  - RailsGuide.jpの間違い修正
    - https://github.com/yasslab/railsguides.jp #702, #707, #712
  - RailsGuide本家のサンプルコードにWhiteSpaceを入れて可読性上げる
    - https://github.com/rails/rails/pull/33898

---

## 本題

---

## Arelのモンキーパッチ対応

---

## 経緯

- 検索機能が表示されない

---

## 調べてみた

- Ransack gemが怪しい
  - Ransackerという特殊な機能を使うときだけ起きる

---

## 原因はArelだった

- #TODO: Arelのコードを貼る

---

## 最新のArelはバグフィックスしてる

- Arel gem のバージョンを上げたいが...
  - Arelのバージョンだけ上げるならよいが...
  - 他のgemも絡んで影響範囲が大きい
    - 将来的にバージョンアップするが、今の時期は危険
    - バージョン上げても、デグレ対応しきれないかも...

---

## 黒魔術発動：モンキーパッチ

```ruby
if Gem::Version.create(Arel::VERSION) < Gem::Version.create('7.0.0')
  class Arel::Nodes::Quoted < Arel::Nodes::Unary
    alias :val :value
    def nil?; val.nil?; end
  end
end
```

---

## 気をつけたこと

- gemのバージョン
  - Arel7.0.0は既に対応してるのでモンキーパッチを当てる必要はない
  - むしろ当てたら、gemのバージョンを上げたときのコミットが入らなくなってしまう
    - モンキーパッチが上書きしちゃうので

- 参考：クックパッドさん
  - https://techlife.cookpad.com/entry/a-guide-to-monkey-patchers

---

## 以上
