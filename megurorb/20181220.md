## Arelã®ãƒ¢ãƒ³ã‚­ãƒ¼ãƒ‘ãƒƒãƒå¯¾å¿œ

@tkoyama1988

---

## èª°?ï¼ˆWho am I?ï¼‰

- @tkoyama1988 å°å±±è²´ä¹‹
- æ ªå¼ä¼šç¤¾SUPER STUDIO ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- çµŒæ­´
  - ãƒã‚¤ãƒˆ/æ­£ç¤¾å“¡ 3å¹´ï¼šä¸»ã«Android
  - å€‹äººäº‹æ¥­ä¸» 2.5å¹´ï¼šAndroid, Unity, Back, Front
  - æ³•äººåŒ– 1.5å¹´ï¼šã‚¹ãƒãƒ›å…¨èˆ¬, AWS, Back, Front
  - SUPERSTUDIO 10æœˆå…¥ç¤¾ï¼šä¸»ã«Rails
- ãŠé…’å¥½ãğŸ¤¤

--

- è³‡æ ¼
  - åŸºæœ¬/å¿œç”¨æƒ…å ±æŠ€è¡“è€…
  - LPIC1/2
  - CCNA
  - Androidãƒ™ãƒ¼ã‚·ãƒƒã‚¯
  - JavaSE8/Ruby2.1 Silver/Gold

---

## SUPER STUDIOã§ä½•ã—ã¦ã‚‹ã®ï¼Ÿ

![image](megurorb/img/product.png)

---

## ç¤¾å¤–æ´»å‹•
- RailsGuideã«PRã™ã‚‹

---

## RailsGuideã«PRã™ã‚‹
- RailsGuide.jpã®é–“é•ã„ä¿®æ­£
  - https://github.com/yasslab/railsguides.jp
    - #702, #707, #712
- RailsGuideæœ¬å®¶ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã«WhiteSpaceã‚’å…¥ã‚Œã¦å¯èª­æ€§ä¸Šã’ã‚‹
  - https://github.com/rails/rails/pull/33898

---

## æœ¬é¡Œ

---

## Arelã®ãƒ¢ãƒ³ã‚­ãƒ¼ãƒ‘ãƒƒãƒå¯¾å¿œ

---

## çµŒç·¯

- é–‹ç™ºã—ãŸæ¤œç´¢ç”»é¢ã§ãƒã‚°ãŒè¦‹ã¤ã‹ã‚‹(CS -> PG)
- æ¤œç´¢é …ç›®ã«å…¥åŠ›ã—ã¦ã‚‚å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„
  - æ—¥ä»˜ã®ç¯„å›²æ¤œç´¢
- ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯å­˜åœ¨ã—ã¦ã„ã‚‹

---

## èª¿ã¹ã¦ã¿ãŸ

- å¯¾è±¡ã®æ¤œç´¢é …ç›®ã¯ Ransack ã® Ransacker ã‚’ä½¿ç”¨ã—ã¦ã„ãŸ
  - ransacker: æ¤œç´¢æ‹¡å¼µæ©Ÿèƒ½
- ã©ã†ã‚„ã‚‰ Ransack ãŒæ€ªã—ã„

---

## Ransack ã¨ Ransacker
### é€šå¸¸Ransack
- å­˜åœ¨ã™ã‚‹ã‚«ãƒ©ãƒ ã«suffixã¤ã‘ã¦æ¤œç´¢ã™ã‚‹
```ruby
pry(main)> Model.ransack(created_at_not_null: true).result.to_sql
=> "SELECT `model`.* FROM `model` WHERE `model`.`created_at` IS NOT NULL"
```
- æƒ³å®šé€šã‚Š

---

## Ransack ã¨ Ransacker
### Ransaker
- ã‚«ãƒ©ãƒ ã«å­˜åœ¨ã—ãªã„æ¤œç´¢é …ç›®ã‚’å®šç¾©ã§ãã‚‹
- å®šç¾©ã—ãŸã‚«ãƒ©ãƒ ã§æ¤œç´¢ã•ã‚ŒãŸã¨ãã¯SQLã‚’è¿”ã™ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹(Model)

```ruby
ransacker :new_column do
  sql = <<-SQL
  # SQLæ–‡ã‚’æ›¸ã select A form B where C.id = B.id
  SQL
  Arel.sql(sql.tr("\n", ' ').strip)
end
```

---

## Ransack ã¨ Ransacker
### Ransaker
- Ransakerã®SQLã‚’ç¢ºèª
```ruby
pry(main)> Model.ransack(new_column_not_null: true).result.to_sql
=> "SELECT `model`.* FROM `model` WHERE ( <SQLæ–‡> ) != NULL"
```
- ä½•ã‹ãŒé•ã†

---

## æ¯”è¼ƒ

### é€šå¸¸Ransack
SELECT * FROM A WHERE A.column `IS NOT` NULL

### Ransacker
SELECT * FROM A WHERE ( SQLæ–‡ ) `!=` NULL

ãˆï¼ŸğŸ˜¨

---

## æ¯”è¼ƒ

### é€šå¸¸Ransack

```ruby
pry(main)> Model.arel_table[:column].not_eq(nil).right
=> #<Arel::Nodes::Casted:0x007f90179398c0 ...>
```

### Ransacker

```ruby
pry(main)> Arel.sql('select * from Model').not_eq(nil).right
=> #<Arel::Nodes::Quoted:0x007f901796bac8 @expr=nil>
```

Arelã®ã‚¯ãƒ©ã‚¹ãŒé•ã†...

---

## åŸå› ã¯Arelã ã£ãŸ
https://github.com/rails/arel
$cat lib/arel/nodes.rb

### Arel6.0.4

```ruby
class Quoted < Arel::Nodes::Unary # :nodoc:
end
```

### Arel7.0.0

```ruby
class Quoted < Arel::Nodes::Unary # :nodoc:
  alias :val :value
  def nil?; val.nil?; end
end
```

---

## æœ€æ–°Arelã¯ãƒã‚°ãƒ•ã‚£ãƒƒã‚¯ã‚¹æ¸ˆã¿

- Arel7.0.0ã§è§£æ±º
- Arel gem ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ãŸã„ãŒ...
  - ä»–ã®gemã‚‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ãªã„ã¨ã„ã‘ãªã„
    - å½±éŸ¿ç¯„å›²ãŒå¤§ãã„ğŸ˜…
    - ãƒ‡ã‚°ãƒ¬å¯¾å¿œã«å·¥æ•°è¶³ã‚Šãªã„ã‹ã‚‚ğŸ˜±
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¯å·¥æ•°äºˆæ¸¬ã§ãã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§

---

## ã˜ã‚ƒã‚ã©ã†ã™ã‚‹ï¼Ÿ

é»’é­”è¡“ä½¿ãŠã†ğŸ˜‡

---


## é»’é­”è¡“ç™ºå‹•ï¼šãƒ¢ãƒ³ã‚­ãƒ¼ãƒ‘ãƒƒãƒ

Arel::Nodes::Quoted ã‚’ä¸Šæ›¸ã

```ruby
if Gem::Version.create(Arel::VERSION) < Gem::Version.create('7.0.0')
  class Arel::Nodes::Quoted < Arel::Nodes::Unary
    alias :val :value
    def nil?; val.nil?; end
  end
end
```

---

## æ°—ã‚’ã¤ã‘ãŸã“ã¨

- gemã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ : Gem::Version
  - Arel7.0.0ã¯æ—¢ã«å¯¾å¿œã—ã¦ã‚‹ã®ã§ãƒ¢ãƒ³ã‚­ãƒ¼ãƒ‘ãƒƒãƒä¸è¦
  - ã‚€ã—ã‚7.0.0ä»¥ä¸Šã®ã¨ãã«ä¸Šæ›¸ã‹ã‚Œã‚‹ã®ã¯å›°ã‚‹

- å‚è€ƒï¼šã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã•ã‚“
  - https://techlife.cookpad.com/entry/a-guide-to-monkey-patchers

---

## ä»¥ä¸Š

---

## æ°—ã‚’ã¤ã‘ãŸã‹ã£ãŸã“ã¨

- èª­ã¿è¾¼ã¿é †ã«ã¤ã„ã¦
  - https://railsguides.jp/configuring.html#ã‚¤ãƒ‹ã‚·ãƒ£ãƒ©ã‚¤ã‚¶ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹

![image](megurorb/img/initialize.png)

---

## ãã®ä»–

ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

![image](megurorb/img/bomb.png)
